@startuml "Sequence onboarding"
actor Tutor
actor Learner
participant "User Controller" as UserController
participant "Auth Guard" as AuthGuard
participant "User Service" as UserService
participant "Collaboration Service" as CollaborationService
participant "Database" as Database
participant "Email Service" as EmailService
participant "Auth Service" as AuthService

Tutor -> UserController: Request to add collaborator
UserController -> AuthGuard: Validate JWT and permissions
alt Session validated
    UserController -> UserService: Check if email is already used
    UserService -> Database: Query for email
    Database -> UserService: Email status
    alt Email already used
        UserService -> CollaborationService: Check if collaboration exists
        CollaborationService -> Database: Verify collaboration for email and tutor_id
        Database -> CollaborationService: Collaboration status
        alt Collaboration exists
            CollaborationService -> UserController: Notify email already in use
            UserController -> Tutor: Email already used
        else Collaboration does not exist
            CollaborationService -> Database: Add new collaboration
            Database -> CollaborationService: Collaboration saved
            CollaborationService -> UserController: Collaboration added successfully
        end
    else Email not used
        UserController -> UserService: Add learner with email
        UserService -> Database: Save learner details
        Database -> UserService: Learner saved
        UserService -> EmailService: Send email with temporary credentials
        EmailService -> Learner: Email sent with temporary login details
    end

    Learner -> UserController: First login with temporary credentials
    UserController -> AuthService: Validate temporary credentials
    AuthService -> UserController: Credentials validated
    UserController -> UserService: Update learner details (password, name, surname)
    UserService -> Database: Save updated learner details
    Database -> UserService: Learner details updated
    UserService -> UserController: Redirect to course page
    UserController -> Learner: Redirect to course page
else Session not validated
    AuthGuard -> UserController: Session not validated
    UserController -> Tutor: Notify session not validated
end

@enduml